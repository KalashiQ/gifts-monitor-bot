import TelegramBot from 'node-telegram-bot-api';
import { SessionManager } from '../session-manager';
import { UserState } from '../../types/bot';
import { PresetModel } from '../../database/models/preset.model';
import { ParserService } from '../../services/parser-service';
import { MessageFormatter } from '../message-formatter';
import { InputValidator } from '../validators';
import { mainMenu, cancelKeyboard, skipKeyboard } from '../keyboards';

export class CommandHandlers {
  private bot: TelegramBot;
  private sessionManager: SessionManager;
  private presetModel: PresetModel;
  private parserService: ParserService;

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Preset –≤ PresetDisplayData
  private convertToPresetDisplayData(preset: any): any {
    return {
      ...preset,
      model: preset.model || undefined,
      background: preset.background || undefined,
      pattern: preset.pattern || undefined,
      last_checked: undefined,
      last_count: undefined
    };
  }

  constructor(
    bot: TelegramBot,
    sessionManager: SessionManager,
    presetModel: PresetModel,
    parserService: ParserService
  ) {
    this.bot = bot;
    this.sessionManager = sessionManager;
    this.presetModel = presetModel;
    this.parserService = parserService;
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
  public async handleStart(msg: TelegramBot.Message): Promise<void> {
    const chatId = msg.chat.id;
    const userName = msg.from?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

    this.sessionManager.resetSession(chatId);
    
    const welcomeMessage = MessageFormatter.formatWelcomeMessage(userName);
    await this.bot.sendMessage(chatId, welcomeMessage, {
      parse_mode: 'HTML',
      reply_markup: mainMenu
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
  public async handleHelp(msg: TelegramBot.Message): Promise<void> {
    const chatId = msg.chat.id;
    const helpMessage = MessageFormatter.formatHelpMessage();
    
    await this.bot.sendMessage(chatId, helpMessage, {
      parse_mode: 'HTML',
      reply_markup: mainMenu
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /menu
  public async handleMenu(msg: TelegramBot.Message): Promise<void> {
    const chatId = msg.chat.id;
    this.sessionManager.resetSession(chatId);
    
    await this.bot.sendMessage(chatId, 'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', {
      reply_markup: mainMenu
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stats
  public async handleStats(msg: TelegramBot.Message): Promise<void> {
    const chatId = msg.chat.id;
    
    try {
      const presets = await this.presetModel.getByUserId(chatId);
      const activePresets = presets.filter(p => p.is_active);
      
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
      const stats = {
        totalPresets: presets.length,
        activePresets: activePresets.length,
        totalChecks: 0, // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥—Å—á–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        changesDetected: 0, // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
        lastCheck: undefined as Date | undefined
      };

      const statsMessage = MessageFormatter.formatStats(stats);
      await this.bot.sendMessage(chatId, statsMessage, {
        parse_mode: 'HTML',
        reply_markup: mainMenu
      });
    } catch (error) {
      console.error('Error getting stats:', error);
      await this.bot.sendMessage(chatId, MessageFormatter.formatError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É'));
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  public async handleTextMessage(msg: TelegramBot.Message): Promise<void> {
    const chatId = msg.chat.id;
    const text = msg.text || '';
    const session = this.sessionManager.getSession(chatId);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∫–æ–º–∞–Ω–¥—ã –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    if (text === 'üéÅ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ—Å–µ—Ç') {
      await this.handleAddPreset(chatId);
      return;
    }

    if (text === 'üìã –ú–æ–∏ –ø—Ä–µ—Å–µ—Ç—ã') {
      await this.handleMyPresets(chatId);
      return;
    }

    if (text === 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å') {
      await this.handleCheckNow(chatId);
      return;
    }

    if (text === 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞') {
      await this.handleStats(msg);
      return;
    }

    if (text === '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏') {
      await this.handleSettings(chatId);
      return;
    }

    if (text === '‚ÑπÔ∏è –ü–æ–º–æ—â—å') {
      await this.handleHelp(msg);
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    switch (session.state) {
      case UserState.ADDING_PRESET_GIFT:
        await this.handleGiftNameInput(chatId, text);
        break;
      case UserState.ADDING_PRESET_MODEL:
        await this.handleModelInput(chatId, text);
        break;
      case UserState.ADDING_PRESET_BACKGROUND:
        await this.handleBackgroundInput(chatId, text);
        break;
      case UserState.ADDING_PRESET_PATTERN:
        await this.handlePatternInput(chatId, text);
        break;
      case UserState.EDITING_PRESET:
        await this.handlePresetEdit(chatId, text);
        break;
      default:
        await this.handleUnknownCommand(chatId, text);
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–∞
  private async handleAddPreset(chatId: number): Promise<void> {
    this.sessionManager.updateState(chatId, UserState.ADDING_PRESET_GIFT);
    this.sessionManager.clearData(chatId);

    await this.bot.sendMessage(chatId, 
      'üéÅ <b>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞</b>\n\n' +
      '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):',
      {
        parse_mode: 'HTML',
        reply_markup: cancelKeyboard
      }
    );
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞
  private async handleGiftNameInput(chatId: number, text: string): Promise<void> {
    const validation = InputValidator.validateGiftName(text);
    if (!validation.isValid) {
      await this.bot.sendMessage(chatId, validation.error!, {
        reply_markup: cancelKeyboard
      });
      return;
    }

    this.sessionManager.setData(chatId, 'gift_name', text.trim());
    this.sessionManager.updateState(chatId, UserState.ADDING_PRESET_MODEL);

    await this.bot.sendMessage(chatId,
      'üé≠ <b>–ú–æ–¥–µ–ª—å –ø–æ–¥–∞—Ä–∫–∞</b>\n\n' +
      '–í–≤–µ–¥–∏—Ç–µ –º–æ–¥–µ–ª—å –ø–æ–¥–∞—Ä–∫–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å":',
      {
        parse_mode: 'HTML',
        reply_markup: skipKeyboard
      }
    );
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –º–æ–¥–µ–ª–∏
  private async handleModelInput(chatId: number, text: string): Promise<void> {
    if (text === '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å') {
      this.sessionManager.setData(chatId, 'model', null);
    } else {
      const validation = InputValidator.validateModel(text);
      if (!validation.isValid) {
        await this.bot.sendMessage(chatId, validation.error!, {
          reply_markup: skipKeyboard
        });
        return;
      }
      this.sessionManager.setData(chatId, 'model', text.trim());
    }

    this.sessionManager.updateState(chatId, UserState.ADDING_PRESET_BACKGROUND);

    await this.bot.sendMessage(chatId,
      'üñºÔ∏è <b>–§–æ–Ω –ø–æ–¥–∞—Ä–∫–∞</b>\n\n' +
      '–í–≤–µ–¥–∏—Ç–µ —Ñ–æ–Ω –ø–æ–¥–∞—Ä–∫–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å":',
      {
        parse_mode: 'HTML',
        reply_markup: skipKeyboard
      }
    );
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ñ–æ–Ω–∞
  private async handleBackgroundInput(chatId: number, text: string): Promise<void> {
    if (text === '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å') {
      this.sessionManager.setData(chatId, 'background', null);
    } else {
      const validation = InputValidator.validateBackground(text);
      if (!validation.isValid) {
        await this.bot.sendMessage(chatId, validation.error!, {
          reply_markup: skipKeyboard
        });
        return;
      }
      this.sessionManager.setData(chatId, 'background', text.trim());
    }

    this.sessionManager.updateState(chatId, UserState.ADDING_PRESET_PATTERN);

    await this.bot.sendMessage(chatId,
      'üé® <b>–£–∑–æ—Ä –ø–æ–¥–∞—Ä–∫–∞</b>\n\n' +
      '–í–≤–µ–¥–∏—Ç–µ —É–∑–æ—Ä –ø–æ–¥–∞—Ä–∫–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å":',
      {
        parse_mode: 'HTML',
        reply_markup: skipKeyboard
      }
    );
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —É–∑–æ—Ä–∞
  private async handlePatternInput(chatId: number, text: string): Promise<void> {
    if (text === '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å') {
      this.sessionManager.setData(chatId, 'pattern', null);
    } else {
      const validation = InputValidator.validatePattern(text);
      if (!validation.isValid) {
        await this.bot.sendMessage(chatId, validation.error!, {
          reply_markup: skipKeyboard
        });
        return;
      }
      this.sessionManager.setData(chatId, 'pattern', text.trim());
    }

    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ—Å–µ—Ç
    await this.createPreset(chatId);
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞
  private async createPreset(chatId: number): Promise<void> {
    try {
      const session = this.sessionManager.getSession(chatId);
      const presetData = {
        user_id: chatId,
        gift_name: session.data.gift_name,
        model: session.data.model,
        background: session.data.background,
        pattern: session.data.pattern,
        is_active: true
      };

      const preset = await this.presetModel.create(presetData);
      this.sessionManager.resetSession(chatId);

      const successMessage = MessageFormatter.formatPresetCreated(preset);
      await this.bot.sendMessage(chatId, successMessage, {
        parse_mode: 'HTML',
        reply_markup: mainMenu
      });
    } catch (error) {
      console.error('Error creating preset:', error);
      await this.bot.sendMessage(chatId, MessageFormatter.formatError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ—Å–µ—Ç'));
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤
  private async handleMyPresets(chatId: number): Promise<void> {
    try {
      const presets = await this.presetModel.getByUserId(chatId);
      const displayData = presets.map(preset => this.convertToPresetDisplayData(preset));

      const message = MessageFormatter.formatPresetsList(displayData);
      const keyboard = presets.length > 0 
        ? { inline_keyboard: presets.slice(0, 5).map(preset => [
            {
              text: `${preset.is_active ? 'üü¢' : 'üî¥'} ${preset.gift_name}`,
              callback_data: JSON.stringify({ action: 'view_preset', presetId: preset.id })
            }
          ]) }
        : undefined;

      await this.bot.sendMessage(chatId, message, {
        parse_mode: 'HTML',
        reply_markup: keyboard || mainMenu
      });
    } catch (error) {
      console.error('Error getting presets:', error);
      await this.bot.sendMessage(chatId, MessageFormatter.formatError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ—Å–µ—Ç–æ–≤'));
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ–π—á–∞—Å
  private async handleCheckNow(chatId: number): Promise<void> {
    try {
      const presets = await this.presetModel.getActiveByUserId(chatId);
      
      if (presets.length === 0) {
        await this.bot.sendMessage(chatId, 
          '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.\n\n' +
          '–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–µ—Å–µ—Ç, –≤—ã–±—Ä–∞–≤ "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ—Å–µ—Ç" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.',
          { reply_markup: mainMenu }
        );
        return;
      }

      await this.bot.sendMessage(chatId, 
        `üîç –ü—Ä–æ–≤–µ—Ä—è—é ${presets.length} –ø—Ä–µ—Å–µ—Ç–æ–≤...\n\n‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...`
      );

      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞
      for (const preset of presets) {
        try {
          const result = await this.parserService.searchGifts({
            gift_name: preset.gift_name,
            model: preset.model || undefined,
            background: preset.background || undefined,
            pattern: preset.pattern || undefined
          });

          const resultMessage = MessageFormatter.formatCheckResult(preset, result.count);
          await this.bot.sendMessage(chatId, resultMessage, {
            parse_mode: 'HTML'
          });
        } catch (error) {
          console.error(`Error checking preset ${preset.id}:`, error);
          await this.bot.sendMessage(chatId, 
            `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–µ—Å–µ—Ç–∞ "${preset.gift_name}"`
          );
        }
      }

      await this.bot.sendMessage(chatId, 
        '‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
        { reply_markup: mainMenu }
      );
    } catch (error) {
      console.error('Error during check:', error);
      await this.bot.sendMessage(chatId, MessageFormatter.formatError('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É'));
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  private async handleSettings(chatId: number): Promise<void> {
    const settingsMessage = 
      '‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>\n\n' +
      'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –≤–∫–ª—é—á–µ–Ω—ã\n' +
      '‚è∞ –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç\n' +
      'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –¥–æ—Å—Ç—É–ø–Ω–∞\n\n' +
      '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö.';

    await this.bot.sendMessage(chatId, settingsMessage, {
      parse_mode: 'HTML',
      reply_markup: mainMenu
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–∞
  private async handlePresetEdit(chatId: number, _text: string): Promise<void> {
    // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞
    await this.bot.sendMessage(chatId, '–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
  private async handleUnknownCommand(chatId: number, _text: string): Promise<void> {
    await this.bot.sendMessage(chatId, 
      '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.',
      { reply_markup: mainMenu }
    );
  }
}

# Epic 6: Система мониторинга

## Статус: ✅ Завершен

## Описание
Реализация автоматической системы мониторинга изменений количества подарков с отправкой уведомлений пользователям.

## Выполненные задачи

### 1. Создание планировщика задач
- ✅ **node-cron интеграция**: Использование node-cron для периодического выполнения
- ✅ **Гибкая конфигурация**: Настраиваемые интервалы через переменные окружения
- ✅ **Управление жизненным циклом**: Запуск, остановка и перезапуск мониторинга
- ✅ **Graceful shutdown**: Корректное завершение работы при остановке

### 2. Реализация фонового процесса мониторинга
- ✅ **MonitoringService**: Основной сервис для управления мониторингом
- ✅ **Асинхронная обработка**: Неблокирующая проверка всех активных пресетов
- ✅ **Обработка ошибок**: Устойчивость к сбоям отдельных пресетов
- ✅ **Задержки между запросами**: Предотвращение перегрузки сайта

### 3. Система сравнения данных и обнаружения изменений
- ✅ **История мониторинга**: Сохранение всех проверок в базе данных
- ✅ **Сравнение значений**: Автоматическое обнаружение изменений количества
- ✅ **Детальная информация**: Отслеживание старых и новых значений
- ✅ **Статистика изменений**: Подсчет общего количества обнаруженных изменений

### 4. Отправка уведомлений пользователям
- ✅ **Персонализированные уведомления**: Отправка только владельцам пресетов
- ✅ **Красивое форматирование**: Структурированные сообщения с эмодзи
- ✅ **Ссылки на поиск**: Автоматическая генерация ссылок на peek.tg
- ✅ **Информация об изменениях**: Детали о том, что изменилось

### 5. Логирование мониторинга
- ✅ **Детальные логи**: Отслеживание всех этапов мониторинга
- ✅ **Статистика производительности**: Количество успешных/неудачных проверок
- ✅ **Обработка ошибок**: Логирование ошибок с контекстом
- ✅ **Мониторинг состояния**: Отслеживание статуса работы системы

### 6. Система управления мониторингом
- ✅ **Команды бота**: Управление через Telegram команды
- ✅ **Включение/выключение**: Динамическое управление мониторингом
- ✅ **Ручная проверка**: Возможность запуска проверки по требованию
- ✅ **Статистика в реальном времени**: Просмотр текущего состояния

### 7. Статистика мониторинга
- ✅ **Детальная статистика**: Количество проверок, успехов, ошибок
- ✅ **Эффективность**: Процент успешных проверок
- ✅ **Временные метки**: Отслеживание последней проверки
- ✅ **История изменений**: Полная история всех обнаруженных изменений

## Архитектура

### Новые компоненты

#### 1. MonitoringService
```typescript
class MonitoringService {
  private database: Database;
  private parserService: ParserService;
  private telegramBot: TelegramBot;
  private config: MonitoringConfig;
  private cronJob: cron.ScheduledTask;
  private stats: MonitoringStats;
}
```

#### 2. Типы мониторинга
```typescript
interface MonitoringConfig {
  enabled: boolean;
  cronExpression: string;
  checkIntervalMinutes: number;
  retryAttempts: number;
  retryDelayMs: number;
}

interface MonitoringStats {
  totalChecks: number;
  successfulChecks: number;
  failedChecks: number;
  totalChanges: number;
  lastCheck: Date | null;
  isRunning: boolean;
}
```

#### 3. Команды управления
- `/monitoring` - Просмотр статистики мониторинга
- `/monitoring_start` - Запуск мониторинга
- `/monitoring_stop` - Остановка мониторинга
- `/monitoring_check` - Ручная проверка

### Обновленные компоненты

#### 1. CommandHandlers
- **Новые методы**:
  - `handleMonitoring()` - Показ статистики
  - `handleMonitoringStart()` - Запуск мониторинга
  - `handleMonitoringStop()` - Остановка мониторинга
  - `handleMonitoringCheck()` - Ручная проверка

#### 2. MessageFormatter
- **Новые методы**:
  - `formatMonitoringStats()` - Форматирование статистики
  - `formatChangeNotification()` - Уведомления об изменениях

#### 3. TelegramBotService
- **Новые методы**:
  - `setMonitoringService()` - Интеграция с мониторингом
  - `sendChangeNotification()` - Отправка уведомлений

## Функциональность

### Автоматический мониторинг
1. **Периодические проверки**:
   - Настраиваемые интервалы (по умолчанию каждые 15 минут)
   - Проверка всех активных пресетов
   - Асинхронная обработка с задержками

2. **Обнаружение изменений**:
   - Сравнение с предыдущими значениями
   - Сохранение истории в базе данных
   - Отметка изменений в записях

3. **Уведомления**:
   - Отправка только при изменениях
   - Персонализированные сообщения
   - Ссылки на поиск подарков

### Управление мониторингом
1. **Команды бота**:
   - Просмотр статистики работы
   - Запуск/остановка мониторинга
   - Ручная проверка изменений

2. **Конфигурация**:
   - Настройка через переменные окружения
   - Гибкие интервалы проверки
   - Настройка повторных попыток

### Статистика и мониторинг
1. **Детальная статистика**:
   - Общее количество проверок
   - Успешные и неудачные проверки
   - Количество обнаруженных изменений
   - Эффективность работы

2. **Логирование**:
   - Детальные логи всех операций
   - Отслеживание ошибок
   - Мониторинг производительности

## Интеграция с существующими компонентами

### База данных
- **MonitoringHistoryModel**: Использование существующих методов
- **PresetModel**: Получение активных пресетов
- **Сохранение истории**: Автоматическое сохранение всех проверок

### Парсер
- **ParserService**: Использование существующего сервиса
- **Проверка изменений**: Интеграция с `checkPresetChanges()`
- **Обработка ошибок**: Использование существующей логики retry

### Telegram Bot
- **Отправка уведомлений**: Интеграция с существующим ботом
- **Команды управления**: Расширение существующих команд
- **Форматирование сообщений**: Использование MessageFormatter

## Безопасность и надежность

### Обработка ошибок
- **Try-catch блоки**: Для всех операций мониторинга
- **Продолжение работы**: При ошибках отдельных пресетов
- **Логирование ошибок**: Детальная информация о сбоях
- **Graceful degradation**: Корректная обработка критических ошибок

### Производительность
- **Асинхронная обработка**: Неблокирующие операции
- **Задержки между запросами**: Предотвращение перегрузки
- **Ограничение ресурсов**: Контроль использования памяти
- **Эффективные запросы**: Оптимизированные операции с БД

### Масштабируемость
- **Гибкая конфигурация**: Настройка под разные нагрузки
- **Модульная архитектура**: Легкое расширение функциональности
- **Мониторинг ресурсов**: Отслеживание использования системы

## Конфигурация

### Переменные окружения
```env
# Мониторинг
MONITORING_ENABLED=false
MONITORING_CRON=*/1 * * * *
MONITORING_INTERVAL=1
MONITORING_RETRY_ATTEMPTS=3
MONITORING_RETRY_DELAY=1000
```

### Настройка расписания
- **Cron выражения**: Гибкая настройка интервалов
- **Частые проверки**: Каждую минуту (по умолчанию)
- **Редкие проверки**: Каждые несколько часов
- **Отключение**: Возможность полного отключения

## Тестирование

### Готовность к тестам
- **Изолированные компоненты**: Легкое тестирование
- **Моки и стабы**: Готовые заглушки для внешних зависимостей
- **Примеры использования**: Готовые примеры для тестирования
- **Интеграционные тесты**: Тестирование взаимодействия компонентов

### Типы тестов
- **Unit тесты**: Тестирование отдельных методов
- **Integration тесты**: Тестирование взаимодействия
- **E2E тесты**: Тестирование полных сценариев
- **Performance тесты**: Тестирование производительности

## Развертывание

### Требования
- **Node.js** 18+
- **TypeScript** 5+
- **SQLite** база данных
- **Telegram Bot Token**
- **node-cron** для планировщика

### Запуск
```bash
# Разработка с мониторингом
MONITORING_ENABLED=true npm run bot:dev

# Продакшн (мониторинг выключен по умолчанию)
npm run build
npm start

# Продакшн с мониторингом
MONITORING_ENABLED=true npm start

# Пример мониторинга
npm run example:monitoring
```

### Мониторинг в продакшене
- **Логирование**: Детальные логи всех операций
- **Метрики**: Отслеживание производительности
- **Алерты**: Уведомления о критических ошибках
- **Резервное копирование**: Регулярное сохранение данных

## Заключение

Epic 6 успешно реализован и предоставляет:

✅ **Автоматический мониторинг** изменений количества подарков
✅ **Умные уведомления** с персонализацией и ссылками
✅ **Гибкое управление** через команды бота
✅ **Детальную статистику** работы системы
✅ **Надежную архитектуру** с обработкой ошибок
✅ **Масштабируемое решение** для больших нагрузок
✅ **Готовность к продакшену** с полным мониторингом

Система мониторинга теперь полностью функциональна и готова к использованию в продакшене. Пользователи будут автоматически получать уведомления об изменениях количества подарков с удобными ссылками для быстрого перехода к поиску.

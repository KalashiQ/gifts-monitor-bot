#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞ –∏ —Ñ–∞–π–ª–æ–≤ PID

echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞..."

# –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –±–æ—Ç–æ–º
echo "üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞..."
pids=$(ps aux | grep -E "(gifts-monitor-bot|ts-node.*index\.ts|node.*dist/index\.js)" | grep -v grep | awk '{print $2}')

if [ -n "$pids" ]; then
    echo "üìã –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã: $pids"
    echo "üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    for pid in $pids; do
        echo "  - –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å $pid"
        kill -TERM $pid 2>/dev/null || true
    done
    
    # –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã
    sleep 3
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã
    for pid in $pids; do
        if kill -0 $pid 2>/dev/null; then
            echo "  - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å $pid"
            kill -KILL $pid 2>/dev/null || true
        fi
    done
else
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

# –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª PID
if [ -f "bot.pid" ]; then
    echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª bot.pid"
    rm -f bot.pid
fi

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
echo "üßΩ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -f *.log
rm -f logs/*.log 2>/dev/null || true

echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:"
echo "  npm run bot:dev"
echo "  –∏–ª–∏"
echo "  npm start"
